<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni Analytics Embed Tester</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Omni Analytics Embed Tester</h1>
            <p>Test different user configurations and see how they affect the embedded BI experience</p>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="config-section">
                    <h2>Configuration</h2>
                    
                    <div class="form-group">
                        <label for="hostname">Omni Hostname</label>
                        <input type="text" id="hostname" placeholder="example.embed-omniapp.co" value="example.embed-omniapp.co">
                    </div>

                    <div class="form-group">
                        <label for="secret">Embed Secret</label>
                        <input type="password" id="secret" placeholder="Your embed secret key">
                        <div class="help-text">
                            <small>Get this from <strong>Admin > Embed</strong> in your Omni instance. Click "Reset Secret" to generate a new one.</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="apiKey">API Key (for 2-step SSO)</label>
                        <input type="password" id="apiKey" placeholder="Your API key">
                    </div>

                    <div class="form-group">
                        <label for="embedType">Embed Type</label>
                        <select id="embedType">
                            <option value="standard">Standard SSO Embed</option>
                            <option value="2step">2-Step SSO Embed</option>
                        </select>
                    </div>
                </div>

                <div class="user-section">
                    <h2>User Parameters</h2>
                    
                    <div class="form-group">
                        <label for="contentPath">Content Path</label>
                        <input type="text" id="contentPath" placeholder="/dashboards/12345678" value="/dashboards/12345678">
                    </div>

                    <div class="form-group">
                        <label for="externalId">External ID</label>
                        <input type="text" id="externalId" placeholder="user123" value="test-user-001">
                    </div>

                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" placeholder="John Doe" value="Test User">
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="user@example.com" value="test@example.com">
                    </div>

                    <div class="form-group">
                        <label for="entity">Entity</label>
                        <input type="text" id="entity" placeholder="Acme Corp" value="Test Company">
                    </div>
                </div>

                <div class="advanced-section">
                    <h2>Advanced Parameters</h2>
                    
                    <div class="form-group">
                        <label for="mode">Mode</label>
                        <select id="mode">
                            <option value="APPLICATION" selected>Application</option>
                            <option value="SINGLE_CONTENT">Single Content</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="theme">Theme</label>
                        <select id="theme">
                            <option value="">Default</option>
                            <option value="vibes">Vibes</option>
                            <option value="minimal">Minimal</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="prefersDark">Prefers Dark Mode</label>
                        <select id="prefersDark">
                            <option value="">Auto</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="linkAccess">Link Access</label>
                        <select id="linkAccess">
                            <option value="">Default</option>
                            <option value="__omni_link_access_open">Open</option>
                            <option value="__omni_link_access_modal">Modal</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="userAttributes">User Attributes (JSON)</label>
                        <textarea id="userAttributes" placeholder='{"department": "sales", "region": "west"}' rows="3">{"department": "sales", "region": "west", "role": "manager"}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="connectionRoles">Connection Roles (JSON)</label>
                        <textarea id="connectionRoles" placeholder='{"connection-id": "RESTRICTED_QUERIER"}' rows="3">{"YOUR_CONNECTION_ID": "RESTRICTED_QUERIER"}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="filterSearchParam">Filter Search Param</label>
                        <input type="text" id="filterSearchParam" placeholder="f--users.country=USA">
                    </div>

                    <div class="form-group">
                        <label for="groups">Groups (JSON)</label>
                        <textarea id="groups" placeholder='["group1", "group2"]' rows="2">["sales-team", "managers"]</textarea>
                    </div>
                </div>

                <div class="preset-section">
                    <h2>Quick Presets</h2>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="basic">Basic User</button>
                        <button class="preset-btn" data-preset="admin">Admin User</button>
                        <button class="preset-btn" data-preset="restricted">Restricted User</button>
                        <button class="preset-btn" data-preset="dark">Dark Theme</button>
                        <button class="preset-btn" data-preset="workbook">Workbook Mode</button>
                    </div>
                </div>

                <div class="action-section">
                    <button id="generateUrl" class="primary-btn">Generate Embed URL</button>
                    <button id="clearForm" class="secondary-btn">Clear Form</button>
                    <button id="testButton" class="secondary-btn" style="background: #e53e3e; color: white;">Test Button</button>
                </div>
            </div>

            <div class="content-area">
                <div class="url-display">
                    <h2>Generated URL</h2>
                    <div class="url-container">
                        <textarea id="generatedUrl" readonly placeholder="Generated URL will appear here..."></textarea>
                        <button id="copyUrl" class="copy-btn">Copy URL</button>
                    </div>
                </div>

                <div class="embed-preview">
                    <h2>Embed Preview</h2>
                    <div class="iframe-container">
                        <iframe id="embedFrame" 
                                src="about:blank" 
                                frameborder="0"
                                sandbox="allow-scripts allow-forms allow-popups allow-top-navigation allow-same-origin"
                                style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                        </iframe>
                        <div id="iframeError" class="iframe-error" style="display: none;">
                            <div class="error-content">
                                <h3>‚ö†Ô∏è Iframe Blocked by CSP Policy</h3>
                                <p>The embed URL cannot be displayed in this iframe due to Content Security Policy (CSP) restrictions.</p>
                                <div class="error-solutions">
                                    <h4>Issue:</h4>
                                    <p>Omni's server only allows iframe embedding from <code>http://localhost</code> (without port). Make sure you're accessing the app at <code>http://localhost</code> (not <code>http://localhost:8080</code>).</p>
                                <h4>Solutions:</h4>
                                <ul>
                                    <li><strong>Open in New Tab:</strong> Click the button below to open the embed in a new browser tab</li>
                                    <li><strong>Copy URL:</strong> Use the copy button to test the URL in your own environment</li>
                                    <li><strong>Check URL:</strong> Make sure you're accessing <code>http://localhost</code> (not <code>http://localhost:8080</code>)</li>
                                    <li><strong>Restart Server:</strong> Use <code>sudo npm run dev</code> to restart on port 80</li>
                                    <li><strong>Update CSP:</strong> Ask your Omni administrator to allow your domain</li>
                                </ul>
                                <p><strong>Note:</strong> If you see React errors in the console, these are coming from the Omni application itself and may indicate parameter issues or Omni server problems.</p>
                                </div>
                                <button id="openInNewTab" class="primary-btn">Open in New Tab</button>
                            </div>
                        </div>
                    </div>
                    <div class="embed-controls">
                        <button id="loadEmbed" class="primary-btn">Load Embed</button>
                        <button id="refreshEmbed" class="secondary-btn">Refresh</button>
                    </div>
                </div>

                <div class="debug-info">
                    <h2>Debug Information</h2>
                    <div class="debug-content">
                        <h3>URL Parameters</h3>
                        <pre id="urlParams"></pre>
                        <h3>Signature Data</h3>
                        <pre id="signatureData"></pre>
                        <h3>Debug Information</h3>
                        <pre id="debugInfo"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Note: Omni SDK loading removed - we use the API method instead which doesn't require the SDK -->
    <script src="script.js"></script>
    <script>
        // Initialize the app immediately - don't wait for Omni SDK
        // The SDK is optional and only needed for certain features
        (function() {
            console.log('üöÄ Initializing OmniEmbedTester app...');
            console.log('üöÄ Script.js loaded:', typeof OmniEmbedTester !== 'undefined');
            console.log('üöÄ DOM ready:', document.readyState);
            
            // Wait for DOM to be fully ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
            
            function initializeApp() {
                try {
                    if (typeof window.omniApp === 'undefined') {
                        if (typeof OmniEmbedTester === 'undefined') {
                            console.error('‚ùå OmniEmbedTester class not found!');
                            alert('Error: OmniEmbedTester class not found. Please check that script.js is loaded correctly.');
                            return;
                        }
                        window.omniApp = new OmniEmbedTester();
                        console.log('‚úÖ App initialized successfully');
                    } else {
                        console.log('App already initialized');
                    }
                } catch (error) {
                    console.error('‚ùå Failed to initialize app:', error);
                    console.error('Error stack:', error.stack);
                    alert('Failed to initialize app: ' + error.message + '\n\nPlease check the console for details.');
                }
            }
        })();

        // Hot reload support - check for file changes every 2 seconds in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            let lastModified = null;
            
            function checkForUpdates() {
                fetch('/api/check-updates')
                    .then(response => response.json())
                    .then(data => {
                        if (lastModified && data.lastModified !== lastModified) {
                            console.log('üîÑ Files changed, reloading...');
                            window.location.reload();
                        }
                        lastModified = data.lastModified;
                    })
                    .catch(() => {
                        // Ignore errors, just retry later
                    });
            }
            
            // Check for updates every 2 seconds
            setInterval(checkForUpdates, 2000);
        }
    </script>
</body>
</html>